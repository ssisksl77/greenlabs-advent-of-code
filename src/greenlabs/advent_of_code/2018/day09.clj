(ns greenlabs.advent-of-code.2018.day09)
; --- Day 9: Marble Mania ---

;; 매개변수로 넣어서 없애야함. 귀찮...
(def score (atom {}))

(def players 435)

(defn step
  [col ^long prev ^long e]
  (cond
    (empty? col)
    [[0] 0 1]

    (= (count col) 1)
    [[0 1] 1 2]

    (= (count col) 2)
    [[0 2 1] 1 3]

    (= 0 (mod e 23))
    (let [pivot (mod (+ (count col) (- prev 7)) (count col))
          removed-number (nth col pivot)
          scored-player (mod e players)]
      (swap! score update scored-player (fnil + 0) (+ e removed-number))
      #_(prn [e @score])
      [(vec (concat (subvec col 0 pivot)
                    (subvec col (inc pivot))))
       pivot
       (inc e)])

    :else
    (let [pivot (+ 2 prev)]
      (if (= pivot (count col))
        [(vec (concat (subvec col 0 pivot)
                    [e]
                    (subvec col pivot)))
         pivot
         (inc e)]
        (let [pivot' (mod pivot (count col))]
          [(vec (concat (subvec col 0 pivot')
                    [e]
                    (subvec col pivot')))
         pivot'
         (inc e)])))))

(comment
  (step [] 0 0)
  (apply step (step [] 0 0))
  (apply step (apply step (step [] 0 0)))
  (apply step (apply step (apply step (step [] 0 0))))
  (apply step (apply step (apply step (apply step (step [] 0 0)))))
  (apply step (apply step (apply step (apply step (apply step (step [] 0 0))))))
  (apply step (apply step (apply step (apply step (apply step (apply step (step [] 0 0)))))))
  (apply step (apply step (apply step (apply step (apply step (apply step (apply step (step [] 0 0))))))))
  (apply step (apply step (apply step (apply step (apply step (apply step (apply step (apply step (step [] 0 0)))))))))
  (apply step [[0 8 4 9 2 10 5 11 1 6 3 7] 7 12]))

;; part 1
(time (nth (iterate #(apply step %) [[] 0 0]) 71184))
;; 412959
(time (nth (iterate #(apply step %) [[] 0 0]) 7118400))

#_[144072 {0 1299246, 357 1438932, 275 1319109, 389 1430213, 410 1454803, 433 1371323, 291 1312108, 249 1227211, 299 1502516, 121 1402658, 287 1210865, 65 1363195, 70 1370677, 218 1363077, 62 1414572, 74 1292773, 164 1381838, 282 1503714, 273 1279489, 186 1412467, 430 1563558, 370 1431329, 233 1256705, 298 1331046, 188 1315889, 240 1524137, 110 1289752, 130 1470430, 311 1449234, 128 1447542, 399 1306798, 377 1417550, 259 1508637, 210 1290734, 229 1262374, 153 1338088, 213 1313505, 343 1310482, 7 1285650, 59 1211405, 86 1399711, 154 1281561, 20 1288010, 224 1380356, 355 1431970, 72 1329258, 58 1394660, 205 1361928, 60 1339571, 175 1349353, 322 1389071, 27 1385419, 352 1388871, 416 1330958, 1 1293982, 69 1462944, 101 1260714, 24 1218780, 102 1412579, 385 1324210, 135 1169840, 397 1312324, 354 1424164, 360 1369749, 55 1294110, 269 1371683, 206 1403000, 165 1463089, 387 1361560, 85 1482662, 225 1385430, 297 1475490, 39 1420730, 274 1389880, 88 1446805, 217 1448330, 46 1368252, 149 1452273, 415 1383835, 239 1394331, 157 1329413, 345 1333534, 300 1296010, 4 1273448, 204 1382143, 77 1398300, 106 1506657, 197 1332844, 405 1439255, 232 1305516, 260 1368930, 267 1399409, 119 1347648, 319 1288318, 222 1400613, 293 1369526, 95 1225810, 329 1293600, 144 1470653, 176 1298392, 349 1412848, 192 1263450, 54 1539984, 92 1504252, 221 1543946, 141 1297158, 307 1348557, 290 1427527, 361 1352519, 264 1272389, 137 1185747, 356 1453318, 327 1215154, 234 1357347, 104 1454259, 353 1503541, 15 1388135, 48 1433678, 242 1552811, 50 1482986, 251 1295328, 394 1419382, 116 1190614, 75 1453491, 159 1373123, 99 1234217, 281 1315543, 402 1264328, 429 1430443, 309 1415183, 21 1230659, 388 1313726, 31 1494623, 113 1403578, 32 1404749, 407 1488507, 398 1335994, 136 1296884, 139 1230781, 396 1375542, 174 1264928, 331 1348661, 363 1147365, 284 1438050, 208 1348930, 305 1360621, 182 1435715, 256 1332608, 214 1274161, 193 1253843, 241 1397510, 314 1418887, 226 1289882, 235 1303706, 420 1294961, 418 1277062, 262 1322507, 263 1506198, 304 1209055, 401 1301186, 40 1233076, 129 1407659, 317 1331514, 294 1302431, 91 1324551, 364 1303342, 412 1421206, 341 1383978, 117 1303375, 172 1317613, 108 1510701, 156 1148691, 358 1434403, 308 1235966, 223 1571894, 419 1260931, 365 1190245, 181 1326786, 417 1318578, 278 1486969, 56 1485313, 33 1534027, 13 1424297, 22 1227945, 380 1289840, 257 1464520, 338 1401177, 168 1436715, 347 1374583, 90 1481297, 237 1348235, 292 1456555, 109 1462378, 216 1324263, 191 1285471, 375 1434879, 367 1277601, 143 1354867, 178 1350077, 247 1255346, 328 1374018, 391 1467385, 167 1389434, 36 1301825, 41 1401346, 187 1419237, 376 1384378, 195 1288721, 316 1455858, 428 1525734, 303 1409072, 368 1399535, 310 1305815, 366 1351737, 118 1181152, 150 1385257, 313 1487753, 384 1404886, 238 1486299, 196 1402946, 162 1337310, 393 1418566, 184 1426496, 219 1490967, 89 1358774, 100 1379896, 426 1487229, 351 1450812, 243 1333270, 131 1418727, 122 1314449, 43 1220813, 231 1220168, 61 1230391, 413 1401066, 29 1449145, 151 1384232, 369 1322488, 348 1268962, 44 1311305, 258 1373903, 250 1197334, 301 1470910, 424 1411942, 93 1273117, 6 1351587, 408 1406503, 111 1485882, 28 1321686, 374 1455056, 411 1375744, 134 1327979, 64 1452822, 334 1515314, 323 1187718, 189 1344858, 280 1521153, 198 1455485, 155 1271418, 295 1433104, 248 1231860, 285 1223313, 227 1317999, 220 1399895, 103 1326157, 170 1362897, 51 1388599, 25 1322918, 261 1535328, 201 1427638, 166 1413634, 34 1346346, 252 1248551, 325 1186561, 146 1460902, 228 1280512, 306 1170209, 125 1483227, 276 1442377, 340 1234870, 148 1447793, 17 1322686, 312 1369279, 3 1247845, 286 1380220, 279 1365391, 12 1514094, 332 1478569, 330 1433359, 382 1336372, 152 1343314, 342 1182842, 2 1283599, 66 1278126, 236 1430868, 373 1410923, 142 1437517, 359 1361695, 371 1367360, 107 1430123, 23 1265626, 230 1235391, 47 1305494, 180 1397453, 158 1237224, 350 1324775, 35 1557451, 127 1497149, 383 1284669, 302 1238395, 82 1283669, 76 1232247, 215 1376755, 97 1168368, 277 1360278, 19 1292116, 335 1438093, 57 1275445, 202 1352850, 68 1328518, 200 1519319, 11 1375221, 115 1364560, 339 1451261, 431 1367952, 337 1467138, 255 1412335, 9 1330313, 427 1394338, 145 1397347, 5 1247317, 244 1539450, 289 1254258, 112 1219065, 414 1337778, 179 1272676, 344 1141897, 245 1295287, 378 1361487, 266 1259694, 324 1359990, 254 1284303, 404 1326840, 283 1283794, 83 1418728, 138 1349481, 346 1225760, 14 1550326, 265 1426725, 333 1400570, 326 1353575, 45 1255970, 53 1333883, 78 1193857, 315 1535817, 132 1415528, 26 1283117, 123 1445653, 203 1420905, 392 1390157, 140 1373503, 321 1214212, 268 1213259, 16 1574288, 320 1468118, 133 1194660, 288 1381834, 381 1278650, 163 1460807, 81 1376405, 120 1264796, 79 1357669, 211 1261252, 38 1238845, 173 1303625, 126 1412559, 421 1269460, 98 1326854, 422 1346509, 423 1304028, 409 1332976, 124 1362006, 171 1275163, 87 1522903, 169 1381658, 160 1267488, 30 1364863, 400 1281653, 207 1361595, 434 1346474, 194 1340282, 73 1522017, 336 1486906, 96 1362207, 10 1460771, 272 1331953, 386 1234308, 270 1276945, 271 1220606, 18 1499155, 395 1389739, 403 1367126, 105 1383207, 185 1399554, 52 1512274, 114 1217135, 253 1356813, 209 1283813, 147 1433314, 425 1346261, 67 1410649, 296 1344099, 318 1486616, 161 1406745, 372 1484010, 406 1372832, 71 1499311, 42 1249879, 80 1212216, 199 1371479, 37 1489051, 183 1359456, 432 1386265, 379 1322606, 63 1292395, 212 1225346, 94 1449581, 362 1321578, 8 1404142, 246 1465049, 190 1316273, 177 1392799, 49 1345146, 390 1353013, 84 1343207}]
(println "done")

(apply max (vals @score))
